<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Principal</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="images/icon-152.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="white" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Sistema Visitas">
    <meta name="msapplication-TileImage" content="images/icon-144.png">
    <meta name="msapplication-TileColor" content="#FFFFFF">

    <!-- You MUST include jQuery before Fomantic -->
    <script src="lib/jquery.min.js"></script>
    <script src="lib/semantic.min.js"></script>
    <script src="lib/moment-with-locales.min.js"></script>
    <script src="lib/simpleUpload.min.js"></script>
    <script src="js/globals.js"></script>
    <script src="js/utils.js"></script>

    <link rel="stylesheet" type="text/css" href="lib/semantic.min.css">

    <style type="text/css">
        body {
            background-color: #bbbbbb;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .column {
            margin: 10px;
        }

        .col_cal {
            margin-top: 0;
            border-top: 0;
            padding-top: 0;
        }

        div.scrollable {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            text-align: center;
            padding: 20px;
        }

        #factura_file1 {
            display: inline-block;
            width: 70px;
            height: 70px;
            background-color: white;
            border: 4px dashed #B5B5B5;
            color: #B5B5B5;
            font-size: 50px;
            text-align: center;
            padding: 30px;
        }

        .no_visible {
            display: none;
        }
    </style>
</head>

<body>
    <div class="ui borderless menu">
        <div class="menu">
            <a onclick="window.history.back();" class="item">
                <i class="icon large chevron left"></i>
            </a>
        </div>
        <div class="right menu">
            <a href="bienvenido.html" class="ui item">
                <!-- <i class="icon large question outline"></i> -->

                <i class="large question icon"></i>
            </a>
            <a href="profile.html" class="ui item">
                <i class="icon large cog"></i>
            </a>
            <a id="logoutBtn" href="#" class="ui item">
                <i class="sign out large alternate icon"></i>
            </a>
        </div>
    </div>

    <div class="scrollable">
        <div id="loadingCalDimmer" class="ui inverted dimmer">
            <div class="ui text loader">Cargando calendario</div>
        </div>

        <div class="ui middle aligned center aligned grid calendario">
            <div class="column col_cal">
                <h3 id="calendario_titulo">Calendario de visitas</h3>
                <div class="ui calendar" id="inline_calendar"></div>
                <div class="ui secondary menu">
                    <div class="item prevmonth">
                        <i class="left circular inverted chevron icon"></i>
                    </div>
                    <div class="center aligned item">
                        <h3 class="ui center aligned header"></h3>
                    </div>
                    <div class="right aligned item nextmonth">
                        <i class="right circular inverted chevron icon"></i>
                    </div>
                </div>

                <div id="tareasEsp" class="ui left aligned form" style="display: none;">
                    <div class="ui left aligned list">
                        <div class="item">
                            <div id="l_supervision" class="left floated content">
                                <div id="supervision" class="ui toggle checkbox">
                                    <input type="checkbox" name="supervision" tabindex="0" class="hidden">
                                    <label>Tarea de supervision.</label>
                                </div>
                            </div>
                        </div>
                        <div class="item">
                            <div id="l_coordinacion" class="left floated content">
                                <div id="coordinacion" class="ui toggle checkbox">
                                    <input type="checkbox" name="coordinacion" tabindex="0" class="hidden">
                                    <label>Tarea de coordinacion.</label>
                                </div>
                            </div>
                        </div>
                        <div class="item">
                            <div id="l_coorsup" class="left floated content">
                                <div id="coorsup" class="ui toggle checkbox">
                                    <input type="checkbox" name="coorsup" tabindex="0" class="hidden">
                                    <label>Tarea de coordinacion + supervision.</label>
                                </div>
                            </div>
                        </div>
                        <div class="item">
                            <div id="l_docencia1" class="left floated content">
                                <div id="docencia1" class="ui toggle checkbox">
                                    <input type="checkbox" name="docencia1" tabindex="0" class="hidden">
                                    <label>Tarea de docencia - Nivelacion.</label>
                                </div>
                            </div>
                        </div>
                        <div class="item">
                            <div id="l_docencia2" class="left floated content">
                                <div id="docencia2" class="ui toggle checkbox">
                                    <input type="checkbox" name="docencia2" tabindex="0" class="hidden">
                                    <label>Tarea de docencia - General.</label>
                                </div>
                            </div>
                        </div>
                        <div class="item">
                            <div id="l_docencia3" class="left floated content">
                                <div id="docencia3" class="ui toggle checkbox">
                                    <input type="checkbox" name="docencia3" tabindex="0" class="hidden">
                                    <label>Otros.</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ui segment sumario no_visible">
                    <h4 id="summarioHoras">Total horas: Total: <i class="custom circular info icon"></i>
                    </h4>
                    <div class="ui custom popup top bottom transition hidden">
                        <p id="summarioHorasDetalle">
                            Detalle de horas</b><br>Dias de semana <b>14hs</b> <br> Fin de
                            semana
                            <b>4hs</b><br> Feriados <b>0hs</b></br> <br>
                            <b>Valores</b><br>
                            Dias de semana $350<br>
                            Fines de semana $450<br>
                            Feriados $480<br>
                        </p>
                    </div>
                    <h1 class="ui divider"></h1>
                    <div class="ui compact labeled icon menu">

                        <a id="presentar_horarios" style="display: none;" class="item">
                            <i class="calendar outlook icon"></i>
                            <div class="floating left ui icon blue circular label">
                                1
                            </div>
                            Presentar <br>
                            Horarios
                        </a>
                        <a id="descargar_horarios" style="display: none;" class="item">
                            <i class="download icon"></i>
                            <div class="floating left ui icon green circular label">
                                1
                            </div>
                            Descargar <br>
                            Horarios
                        </a>

                        <a id="presentar_factura" class="disabled item">
                            <i class="receipt icon"></i>
                            <div class="fact_label floating left ui icon grey circular label">2</div>
                            Presentar <br>
                            Factura
                        </a>

                        <a id="descargar_factura" style="display: none;" class="item">
                            <i class="receipt icon"></i>
                            <div class="fact_label floating left ui icon green circular label">2</div>
                            Descargar <br>
                            Factura
                        </a>

                        <a id="presentar_informe" class="disabled item">
                            <div class="informe_label floating left ui icon grey circular label">3</div>
                            <i class="edit outline icon"></i>
                            Presentar <br>
                            Informe
                        </a>

                        <a id="descargar_informe" style="display: none;" class="item">
                            <div class="informe_label floating left ui icon green circular label">3</div>
                            <i class="edit outline icon"></i>
                            Descargar <br>
                            Informe
                        </a>
                    </div>
                    <div class="ui ignored liquidado positive icon message" style="display: none;">
                        <div class="content">
                            <p>Mes liquidado.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="importante_modal_dlg" class="ui tiny modal">
        <div class="header">
            Aviso
        </div>
        <div class="content">
            <div class="ui warning message">
                <div class="header">
                    Importante
                </div>
                <div class="contentImportante">
                    <p>Debera presentar los horarios correspondientes al mes de Octubre. </p>
                    <p>El plazo es del 1 al 5 de este mes para presentar las visitas correspondientes al mes corriente.
                    </p>
                    <p>En caso de pasada esa fecha, los honorarios seran procesados a partir del 10 del mes siguiente.
                    </p>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui negative button">
                Entendido
            </div>
        </div>
    </div>

    <div id="presentacion_modal_dlg" class="ui tiny modal">
        <div class="header">
            Presentar horarios
        </div>
        <div id="sendingPrDimmer" class="ui inverted dimmer">
            <div class="ui text loader">Enviando Presentacion</div>
        </div>
        <div id="presentacion_horaria_content" class="content">
            <h4>Se realizara la presentacion horaria correspondiente al mes de Octubre 2020.</h4>
            <p>Se cuenta con un total de 63hs. repartidas entre: </p>
            <ul>
                <li>40hs. DS x 380 = <strong>$1560</strong></li>
                <li>23hs. FS x 400 = <strong>$1560</strong></li>
            </ul>
            <div class="ui divider"></div>
            <h3>Total: $23.940,00</h3>
            <h4>Debera realizar la factura con este importe.</h4>
            <div class="ui error message">
                <div class="header">
                    Aviso
                </div>
                <div class="content">
                    <p id="responseMessage">Se realizara la presentacion horaria, una vez confirmada no se podran
                        actualizar ni editar
                        las
                        visitas del mes.<br>
                        Para pedir una rectificacion debera comunicarse con el administrador.</p>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui negative button">
                Cancelar
            </div>
            <div class="ui positive button">
                Confirmar
            </div>
        </div>
    </div>

    <div id="factura_modal_dlg" class="ui tiny modal">
        <div class="header">
            Carga de factura
        </div>
        <div class="content">
            <div id="sendingFactDimmer" class="ui inverted dimmer">
                <div class="ui text loader">Enviando Factura</div>
            </div>
            <h3 id="totalFacturaDescr">La factura correspondiente a Octubre 2020 debera tener un importe de:</h3>
            <h2 id="totalFactura">$23.940,00</h2>

            <h4 id="mensaje_facturacion"></h4>

            <input class="ui input" id="factura_file" type="file" accept="image/*,application/pdf" name="facfile" />

            <div class="ui warning message">
                <div class="header">
                    Nota
                </div>
                <div class="content">
                    <p>La carga de la factura se puede realizar varias veces pero se podra confirmar una sola vez.</p>
                    <p>En caso que se necesite volver a cargar la factura despues de confirmar debera comunicarse cone
                        el administrador para habilitar la recarga.</p>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui negative button">
                Cerrar
            </div>
        </div>
    </div>

    <div id="informe_modal_dlg" class="ui tiny modal">
        <div class="header">
            Carga de informe
        </div>
        <div class="content">
            <div id="sendingInfDimmer" class="ui inverted dimmer">
                <div class="ui text loader">Guardando</div>
            </div>

            <form id="informe_form" class="ui form">
                <div class="field">
                    <label>Ingresar informe evolutivo del mes del paciente.</label>
                    <textarea id="informe" name="informe"></textarea>
                </div>
                <p id="charnum"></p>
                <div class="ui error message">
                </div>
            </form>
            <div class="ui warning message">
                <div class="header">
                    Nota
                </div>
                <div class="content">
                    <p>En caso que se necesite volver a cargar el informe debera comunicarse con el administrador para
                        habilitar la carga.</p>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui negative button">
                Cancelar
            </div>
            <div class="ui positive button">
                Confirmar
            </div>
        </div>
    </div>

    <div id="confirma_salir_dlg" class="ui modal">
        <div class="header">
            Advertencia
        </div>
        <div class="content">
            <div class="description">
                <h2>&iquest;Desea cerrar sesion&#63;</h2>
            </div>
        </div>
        <div class="actions">
            <div class="ui negative button">
                Cancelar
            </div>
            <div class="ui positive button">
                Confirmar
            </div>
        </div>
    </div>

    <script>
        const apiUrl = "https://www.actoterapeutico.com.ar/api";
        let pac = null;
        let focusDate = null;
        let presentationData = null;
        let tareaEspId = null;
        let id_doc_niv = null;
        let id_doc_gen = null;
        let id_doc_otros = null;
        let params = {};

        $(document).ready(function () {
            if (localStorage.getItem("user") === null) {
                window.location.href = "login.html";
            }

            //$('.ui.checkbox').checkbox();

            //Inicializamos los controles
            $("#summarioHoras1").hide();

            //Si selecciono fecha, la guardamos
            pac = findGetParameter("pac")

            if (pac === null) {
                pac = localStorage.getItem("pac");
            }
            
            if (pac === null) {
                //Si es llamado sin parametro o no esta en localStorage, deslogueamos
                localStorage.removeItem("user");
                localStorage.removeItem("focusDate");
                localStorage.removeItem("pac");
                window.location.href = "login.html";
                return true;
            }

            cargarVisitasCalendario(pac);
            cargarParametros();

            //Si selecciono fecha, la guardamos
            if (localStorage.getItem("focusDate") === null) {
                focusDate = moment();
                localStorage.setItem("focusDate", focusDate.format("YYYY-MM-DDTHH:mm:ss"));
            } else {
                focusDate = moment(localStorage.getItem("focusDate"));
            }

            //mostrarSumario();

            $('#inline_calendar').calendar('set date', focusDate._d);

            // Traemos el estado del mes, si no presento los valores, traemos el estado de la presentacion
            getTotalMonth(focusDate._d);

            //Dialogos
            $("#confirma_salir_dlg").modal({
                onShow: function () {
                },
                onDeny: function () {
                    return true;
                },
                onApprove: function () {
                    localStorage.removeItem("user");
                    localStorage.removeItem("focusDate");
                    localStorage.removeItem("pac");
                    window.location.href = "login.html";
                    return true;
                }
            });

            $("#factura_modal_dlg").modal({
                onShow: function () {
                    let totalFactContent = `$${presentationData["total_pagar"]}`;
                    totalFactContent = totalFactContent.replace(/\./g, ',');

                    let periodo = focusDate.locale("es").format("MMMM YYYY");
                    let facturaDescr = `La factura correspondiente a ${periodo} debera tener un importe de:`;
                    $("#totalFacturaDescr").html(facturaDescr);

                    $("#mensaje_facturacion").html(presentationData["mensaje_facturacion"]);

                    $("#totalFactura").html(totalFactContent);
                },
                onDeny: function () {
                    return true;
                },
                onApprove: function () {
                    //enviarPresentacion();
                    return true;
                }
            });

            $("#informe_modal_dlg").modal({
                onShow: function () {
                    let max_car_informe = params["max_car_informe"];

                    $('#informe_form').form({
                        on: 'change',
                        fields: {
                            informe: {
                                identifier: 'informe',
                                rules: [{
                                    type: 'empty',
                                    prompt: 'Por favor ingrese algun contenido al informe'
                                },
                                {
                                    type: `minLength[${max_car_informe}]`,
                                    prompt: 'Su informe debe contener al menos {ruleValue} caracteres'
                                },
                                {
                                    type: 'maxLength[5000]',
                                    prompt: 'Su informe supera el maximo de {ruleValue} caracteres'
                                }]
                            }
                        }
                    });
                },
                onApprove: function () {
                    //Chequeamos que se haya ingresado el informe
                    let formInforme = $('#informe_form');

                    if (!formInforme.form("validate form")) {
                        return false;
                    }

                    // get all values
                    let allFields = formInforme.form('get values');
                    console.log(allFields);

                    enviarInforme(allFields);
                    return true;
                }
            });

            $("#presentacion_modal_dlg").modal({
                onShow: function () {
                    let periodo = focusDate.locale("es").format("MMMM YYYY");

                    let presentacionHorariaContent = `<h4>Se realizara la presentacion horaria correspondiente al mes de ${periodo}</h4>
                                                      <p>Se cuenta con un total de ${presentationData["total_hs"]}hs. repartidas entre: </p>
                                                      <ul>
                                                          <li>${presentationData["total_hs_ds"]}hs. DS x ${presentationData["valor_hora_ds"]} = <strong>$${presentationData["total_pagar_ds"]}</strong></li>
                                                          <li>${presentationData["total_hs_fs"]}hs. FS x ${presentationData["valor_hora_fs"]} = <strong>$${presentationData["total_pagar_fs"]}</strong></li>
                                                          <li>${presentationData["total_hs_fe"]}hs. FE x ${presentationData["valor_hora_fe"]} = <strong>$${presentationData["total_pagar_fe"]}</strong></li>
                                                          <li>Otras tareas = <strong>$${presentationData["total_pagar_tareas"]}</strong></li>
                                                      </ul>
                                                      <div class="ui divider"></div>
                                                      <h3>Total: $${presentationData["total_pagar"]}</h3>
                                                      <h4>Debera realizar la factura con este importe.</h4>
                                                      <div class="ui warning message">
                                                          <div class="header">
                                                              Aviso
                                                          </div>
                                                          <div class="content">
                                                              <p>Se realizara la presentacion horaria, una vez confirmada no se podr&aacute; actualizar ni editar
                                                                  las visitas del mes<br>
                                                                  Para pedir una rectificaci&oacute;n debera comunicarse con el administrador</p>
                                                          </div>
                                                      </div>
                                                      <div id="message" class="ui negative message" style="display:none;">
                                                          <div class="header">
                                                              Error
                                                          </div>
                                                          <div class="content">
                                                              <p id="responseMessage"></p>
                                                          </div>
                                                      </div>`;
                    presentacionHorariaContent = presentacionHorariaContent.replace(/\./g, ',');


                    $("#presentacion_horaria_content").html(presentacionHorariaContent);
                },
                onApprove: function () {
                    enviarPresentacion();
                    return false;
                }
            });

            //Eventos
            $("#presentar_horarios").click(function () {
                $('#presentacion_modal_dlg').modal('show');
            });

            $("#presentar_factura").click(function () {
                $('#factura_modal_dlg').modal('show');
            });

            $("#presentar_informe").click(function () {
                $('#informe_modal_dlg').modal('show');
            });

            $("#presentar_informe").click(function () {
                $('#informe_modal_dlg').modal('show');
            });

            $("#logoutBtn").click(function () {
                $("#confirma_salir_dlg").modal("show");
            });

            $('#factura_file').change(function () {
                let url = `${apiUrl}/fact_upload.php`;
                let user = JSON.parse(localStorage.getItem('user'));

                let jwtString = `Bearer ${user.jwt}`;

                $(this).simpleUpload(url, {
                    data: {
                        "id": presentationData.id
                    },
                    beforeSend: function (jqXHR, settings) {
                        jqXHR.setRequestHeader('MyAuthorization', jwtString);
                        $("#sendingFactDimmer").addClass("active");
                    },
                    start: function (file) {
                        //upload started
                        console.log("upload started");
                    },

                    progress: function (progress) {
                        //received progress
                        console.log("upload progress: " + Math.round(progress) + "%");
                    },

                    success: function (data) {
                        //upload successful
                        $("#sendingFactDimmer").removeClass("active");
                        $("#factura_modal_dlg").modal('hide');

                        let dias_aviso_factura = parseInt(params["dias_aviso_factura"]);

                        if (day > dias_aviso_factura) {
                            $('.contentImportante').html(params["dias_factura_aviso"]);
                            $('#importante_modal_dlg').modal('show');
                        }

                        getTotalMonth(focusDate._d);
                        console.log("upload successful!");
                        console.log(data);
                    },

                    error: function (error) {
                        //upload failed
                        $("#sendingFactDimmer").removeClass("active");
                        $("#factura_modal_dlg").modal('hide');
                        let hoy = moment();
                        let day = parseInt(hoy.format('D'));
                        let dias_aviso_factura = parseInt(params["dias_aviso_factura"]);
                        if (day > dias_aviso_factura) {
                            $('.contentImportante').html(params["dias_factura_aviso"]);
                            $('#importante_modal_dlg').modal('show');
                        }

                        getTotalMonth(focusDate._d);
                        console.log("upload error: " + error.name + ": " + error.message);
                    }

                });

            });

            $(".nextmonth").click(function (e) {
                e.preventDefault();

                //Si es de un mes anterior, aumentamos un mes
                if (focusDate.isSameOrBefore(moment(), 'month')) {
                    focusDate = moment(focusDate).add(1, 'M');
                    // Si la fecha aumentada es mayor al dia de hoy, ponemos la fecha de hoy
                    if (focusDate.isAfter(moment(), 'day')) {
                        focusDate = moment();
                    }

                    saveFocusDate();
                    setCalFocusDate();
                }

                getTotalMonth(focusDate._d);
            });

            $(".prevmonth").click(function (e) {
                e.preventDefault();

                //Si es de un mes anterior, aumentamos un mes
                if (focusDate.isSameOrBefore(moment(), 'month')) {
                    focusDate = moment(focusDate).subtract(1, 'M');

                    saveFocusDate();
                    setCalFocusDate();
                }

                getTotalMonth(focusDate._d);
            });

            $('#informe').keyup(function () {
                //var max = 5000;
                let max = params["max_car_informe"];
                var len = $(this).val().length;
                if (len >= max) {
                    $('#charnum').text(' Superaste el limite');
                } else {
                    var char = max - len;
                    $('#charnum').text('te quedan ' + char + ' caracteres.');
                }
            });

            $("#descargar_horarios").click(function (e) {
                let month = focusDate._d.getMonth() + 1;
                let year = focusDate._d.getFullYear();

                let requestOptions = {
                    method: 'GET',
                    headers: getMyHeader(),
                    redirect: 'follow'
                };

                let url = `${apiUrl}/presentaciones.php?year=${year}&month=${month}&pac=${pac}&pdf`;

                fetch(url, requestOptions)
                    .then(response => response.blob())
                    .then(blob => {
                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = `presentacion-${month}-${year}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    });

            });

            $("#descargar_factura").click(function (e) {
                let month = focusDate._d.getMonth() + 1;
                let year = focusDate._d.getFullYear();

                let requestOptions = {
                    method: 'GET',
                    headers: getMyHeader(),
                    redirect: 'follow'
                };

                let url = `${apiUrl}/presentaciones.php?year=${year}&month=${month}&pac=${pac}&factura`;

                fetch(url, requestOptions)
                    .then(response => response.blob())
                    .then(blob => {
                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = `factura-${month}-${year}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    });

            });

            $("#descargar_informe").click(function (e) {
                let month = focusDate._d.getMonth() + 1;
                let year = focusDate._d.getFullYear();

                let requestOptions = {
                    method: 'GET',
                    headers: getMyHeader(),
                    redirect: 'follow'
                };

                let url = `${apiUrl}/presentaciones.php?year=${year}&month=${month}&pac=${pac}&informe`;

                fetch(url, requestOptions)
                    .then(response => response.blob())
                    .then(blob => {
                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = `informe-${month}-${year}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    });

            });


            //botones check de supervision
            $("#supervision").checkbox({
                onChecked: function () {
                    enviarTarea(2);
                },
                onUnchecked: function () {
                    eliminarTarea();
                }
            });

            $("#coordinacion").checkbox({
                onChecked: function () {
                    enviarTarea(3);
                },
                onUnchecked: function () {
                    eliminarTarea();
                }
            });

            $("#coorsup").checkbox({
                onChecked: function () {
                    enviarTarea(4);
                },
                onUnchecked: function () {
                    eliminarTarea();
                }
            });

            //botones check de docencia
            $("#docencia1").checkbox({
                onChecked: function () {
                    enviarTarea(5);
                },
                onUnchecked: function () {
                    tareaEspId = id_doc_niv;
                    eliminarTarea();
                }
            });

            $("#docencia2").checkbox({
                onChecked: function () {
                    enviarTarea(6);
                },
                onUnchecked: function () {
                    tareaEspId = id_doc_gen;
                    eliminarTarea();
                }
            });

            $("#docencia3").checkbox({
                onChecked: function () {
                    enviarTarea(7);
                },
                onUnchecked: function () {
                    tareaEspId = id_doc_otros;
                    eliminarTarea();
                }
            });

        });

        // Get a value from the querystring
        function findGetParameter(parameterName) {
            var result = null,
                tmp = [];
            var items = location.search.substr(1).split("&");
            for (var index = 0; index < items.length; index++) {
                tmp = items[index].split("=");
                if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
            }
            return result;
        }

        function cargarVisitasCalendario(pac) {
            let requestOptions = {
                method: 'GET',
                headers: getMyHeader(),
                redirect: 'follow'
            };

            let url = `${apiUrl}/visitas.php`;

            if (pac != undefined) {
                url = `${apiUrl}/visitas.php?pac=${pac}&calendarview=1`
            }

            $("#loadingCalDimmer").addClass("active");
            //*****************************************
            fetch(url, requestOptions)
                .then(function (res) {
                    return res.json(); //error here
                }).then(function (data) {
                    $("#loadingCalDimmer").removeClass("active");
                    $('.calendario').show();

                    let events = [];

                    for (const key in data) {
                        if (data.hasOwnProperty(key)) {
                            const element = data[key];
                            let parts = element.dt.split('-');

                            var mydate = new Date(parts[0], parts[1] - 1, parts[2]);

                            let typeClass = "";

                            typeClass = element.cantidad_solapados == '0' ? 'green' : 'inverted orange';
                            typeClass = element.tareas_especiales == '0' ? 'green' : 'inverted violet';

                            let indicador = element.cantidad_solapados == '0' ? 'Visitas' : 'Visitas solapadas';

                            //class: 'inverted orange'
                            let event = {
                                date: mydate,
                                message: indicador,
                                class: typeClass
                            }
                            events.push(event);
                        }
                    }

                    initializeCalendar(events);
                    return;
                }).catch((error) => {
                    console.log(error);
                });

        }

        Date.isLeapYear = function (year) {
            return (((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0));
        };

        Date.getDaysInMonth = function (year, month) {
            return [31, (Date.isLeapYear(year) ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month];
        };

        Date.prototype.isLeapYear = function () {
            return Date.isLeapYear(this.getFullYear());
        };

        Date.prototype.getDaysInMonth = function () {
            return Date.getDaysInMonth(this.getFullYear(), this.getMonth());
        };

        Date.prototype.addMonths = function (value) {
            var n = this.getDate();
            this.setDate(1);
            this.setMonth(this.getMonth() + value);
            this.setDate(Math.min(n, this.getDaysInMonth()));
            return this;
        };

        function formatDate(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('');
        }

        function initializeCalendar(events) {
            let user = JSON.parse(localStorage.getItem('user'));

            //Mostramos u ocultamos las tareas de coordinacion, supervision y docencia
            let permisos = user["permisos"].split(',');

            let typeCal = "day";

            //Si no carga horarios, ponemos el modo mes
            if (permisos[3] == "1") {
                typeCal = "month";
                $("#tareasEsp").show();
            } else {
                typeCal = "day";
                $("#tareasEsp").hide();
            }

            let today = new Date();
            $('#inline_calendar').html('');
            $('#inline_calendar')
                .calendar({
                    type: typeCal,
                    inline: true,
                    disableYear: true,
                    disableMonth: true,
                    text: {
                        days: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
                        months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                        monthsShort: ['En', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                        today: 'Hoy',
                        now: 'Ahora',
                        am: 'AM',
                        pm: 'PM'
                    },
                    eventDates: events,
                    maxDate: new Date(today.getFullYear(), today.getMonth(), today.getDate()),
                    onSelect(date, mode) {
                        let user = JSON.parse(localStorage.getItem('user'));

                        //Mostramos u ocultamos las tareas de coordinacion, supervision y docencia
                        let permisos = user["permisos"].split(',');

                        //Si no carga horarios, ponemos el modo mes
                        if (permisos[3] == "1") {
                            focusDate = moment(date);
                            localStorage.setItem("focusDate", focusDate.format("YYYY-MM-DDTHH:mm:ss"));
                            getTotalMonth(focusDate._d);
                            return;
                        } else {
                            focusDate = moment(date);
                            localStorage.setItem("focusDate", focusDate.format("YYYY-MM-DDTHH:mm:ss"));
                            let formatted_date = formatDate(date);
                            let url = `/visitas.html?date=${formatted_date}&pac=${pac}`;
                            window.location = url;
                        }
                    },
                    className: {
                        prevIcon: '',
                        nextIcon: ''
                    }
                });

            if (focusDate !== null) {
                $('#inline_calendar').calendar('set date', focusDate._d);
                getTotalMonth(focusDate._d);
            }

        }

        function getTotalMonth(date) {
            let month = date.getMonth() + 1;
            let year = date.getFullYear();

            let requestOptions = {
                method: 'GET',
                headers: getMyHeader(),
                redirect: 'follow'
            };

            let url = `${apiUrl}/presentaciones.php?year=${year}&month=${month}&pac=${pac}&presentacion`;

            $(".sumario").hide();
            fetch(url, requestOptions)
                .then(function (res) {
                    return res.json(); //error here
                }).then(function (data) {
                    presentationData = data;

                    //Si docencia esta en 1, entonces deshabilitamos el resto.
                    if (presentationData["docencia"] == 1) {
                        $("#l_supervision").hide();
                        $("#l_coordinacion").hide();
                        $("#l_coorsup").hide();
                        $("#l_docencia1").show();
                        $("#l_docencia2").show();
                        $("#l_docencia3").show();

                        //segun lo que vino en los totales, chequeamos o deschequeamos
                        $("#docencia1").checkbox("set unchecked");
                        $("#docencia2").checkbox("set unchecked");
                        $("#docencia3").checkbox("set unchecked");
                        $("#docencia1").removeClass("disabled");
                        $("#docencia2").removeClass("disabled");
                        $("#docencia3").removeClass("disabled");


                        if (presentationData["tiene_doc_niv"] == "S") {
                            id_doc_niv = presentationData["id_doc_niv"];
                            $("#docencia1").checkbox("set checked");
                        }
                        if (presentationData["tiene_doc_gen"] == "S") {
                            id_doc_gen = presentationData["id_doc_gen"];
                            $("#docencia2").checkbox("set checked");
                        }
                        if (presentationData["tiene_doc_otros"] == "S") {
                            id_doc_otros = presentationData["id_doc_otros"];
                            $("#docencia3").checkbox("set checked");
                        }

                    } else {
                        $("#l_supervision").show();
                        $("#l_coordinacion").show();
                        $("#l_coorsup").show();
                        $("#l_docencia1").hide();
                        $("#l_docencia2").hide();
                        $("#l_docencia3").hide();

                        //segun lo que vino en los totales, chequeamos o deschequeamos
                        if (presentationData["tiene_coord"] == "S") {
                            tareaEspId = presentationData["id_tarea_esp"];
                            $("#coordinacion").checkbox("set checked");
                            $("#supervision").checkbox("set unchecked");
                            $("#coorsup").checkbox("set unchecked");
                            //Si selecciono uno, deshabilitamos los otros
                            $("#coordinacion").removeClass("disabled");
                            $("#supervision").addClass("disabled");
                            $("#coorsup").addClass("disabled");
                        } else if (presentationData["tiene_sup"] == "S") {
                            tareaEspId = presentationData["id_tarea_esp"];
                            $("#coordinacion").checkbox("set unchecked");
                            $("#supervision").checkbox("set checked");
                            $("#coorsup").checkbox("set unchecked");
                            //Si selecciono uno, deshabilitamos los otros
                            $("#coordinacion").addClass("disabled");
                            $("#supervision").removeClass("disabled");
                            $("#coorsup").addClass("disabled");
                        } else if (presentationData["tiene_coordsup"] == "S") {
                            tareaEspId = presentationData["id_tarea_esp"];
                            $("#coordinacion").checkbox("set unchecked");
                            $("#supervision").checkbox("set unchecked");
                            $("#coorsup").checkbox("set checked");
                            //Si selecciono uno, deshabilitamos los otros
                            $("#coordinacion").addClass("disabled");
                            $("#supervision").addClass("disabled");
                            $("#coorsup").removeClass("disabled");
                        } else {
                            $("#coordinacion").checkbox("set unchecked");
                            $("#supervision").checkbox("set unchecked");
                            $("#coorsup").checkbox("set unchecked");

                            $("#coordinacion").removeClass("disabled");
                            $("#supervision").removeClass("disabled");
                            $("#coorsup").removeClass("disabled");
                        }

                    }

                    //Si vinieron horas o hay tareas especiales
                    if (data.total_hs || data.total_pagar_tareas > 0) {
                        $(".sumario").show();
                        $(".sumario").removeClass("no_visible");
                    } else {
                        $(".sumario").hide();
                        $(".sumario").addClass("no_visible");
                        return;
                    }

                    let sumarioHoras = `Total de horas: ${data["total_hs"]}hs Total: $${data["total_pagar"]} <i class="custom circular info icon"></i>`;
                    let horasInternacion = '';

                    if (data["valor_hora_ds_int"] != null) {
                        horasInternacion = `<b>Valores Internacion</b><br>
                                        Dias de semana $${data["valor_hora_ds_int"]}<br>
                                        Fines de semana $${data["valor_hora_fs_int"]}<br>
                                        Feriados $${data["valor_hora_fe_int"]}<br>`;
                    }

                    sumarioHoras = sumarioHoras.replace(/\./g, ',');
                    $("#summarioHoras").html(sumarioHoras);

                    sumarioHoras = `<b>Detalle de horas</b><br>
                                    Dias de semana <b>${data["total_hs_ds"]}hs</b><br> 
                                    Fin de semana <b>${data["total_hs_fs"]}hs</b><br> 
                                    Feriados <b>${data["total_hs_fe"]}hs</b><br>
                                    Otras tareas <b>$${data["total_pagar_tareas"]}</b><br>
                                    <b>Valores</b><br>
                                    Dias de semana $${data["valor_hora_ds"]}<br>
                                    Fines de semana $${data["valor_hora_fs"]}<br>
                                    Feriados $${data["valor_hora_fe"]}<br>
                                    ${horasInternacion}`;

                    sumarioHoras = sumarioHoras.replace(/\./g, ',');
                    $("#summarioHorasDetalle").html(sumarioHoras);

                    $('.custom')
                        .popup({
                            popup: $('.custom.popup'),
                            on: 'click'
                        });

                    $(".fact_label").removeClass("grey");
                    $(".fact_label").removeClass("green");
                    $(".fact_label").removeClass("blue");
                    $(".informe_label").removeClass("grey");
                    $(".informe_label").removeClass("green");
                    $(".informe_label").removeClass("blue");

                    $("#presentar_factura").addClass("disabled");
                    $("#presentar_informe").addClass("disabled");

                    if ("id" in data) {
                        $("#presentar_horarios").hide();
                        $("#descargar_horarios").show();

                        $("#coordinacion").addClass("disabled");
                        $("#supervision").addClass("disabled");
                        $("#coorsup").addClass("disabled");
                        $("#docencia1").addClass("disabled");
                        $("#docencia2").addClass("disabled");
                        $("#docencia3").addClass("disabled");

                        //Si ya se presento el horario, habilitar la carga de factura
                        if (data.factura == "S") {
                            $("#descargar_factura").hide();
                            $("#presentar_factura").show();
                            $("#presentar_factura").removeClass("disabled");
                            $(".fact_label").addClass("green");

                            if (data.informe == "S") {
                                $("#descargar_factura").show();
                                $("#presentar_factura").hide();
                                $(".fact_label").addClass("green");

                                $("#descargar_informe").show();
                                $("#presentar_informe").hide();
                                $("#presentar_informe").addClass("disabled");
                                $(".informe_label").addClass("green");
                            } else {
                                if (presentationData["docencia"] == 1) {
                                    $("#descargar_informe").hide();
                                    $("#presentar_informe").hide();
                                } else {
                                    $("#descargar_informe").hide();
                                    $("#presentar_informe").show();
                                    $("#presentar_informe").removeClass("disabled");
                                    $(".informe_label").addClass("blue");
                                }
                            }

                        } else {
                            $("#descargar_factura").hide();
                            $("#presentar_factura").show();
                            $("#presentar_factura").removeClass("disabled");
                            $(".fact_label").addClass("blue");
                        }

                        if (data.comprobante == "S") {
                            $(".liquidado").show();
                        } else {
                            $(".liquidado").hide();
                        }

                    } else {
                        $("#presentar_horarios").show();
                        $("#descargar_horarios").hide();

                        $(".fact_label").addClass("grey");
                        $(".informe_label").addClass("grey");
                    }
                });

        }

        function enviarPresentacion() {
            let month = focusDate._d.getMonth() + 1;
            let year = focusDate._d.getFullYear();

            let requestOptions = {
                method: 'POST',
                headers: getMyHeader(),
                redirect: 'follow'
            };

            let url = `${apiUrl}/presentaciones.php?year=${year}&month=${month}&pac=${pac}&presentacion`;

            $("#sendingPrDimmer").addClass("active");
            $("#message").hide();
            fetch(url, requestOptions)
                .then(function (res) {
                    return res.json(); //error here
                }).then(function (data) {
                    $("#sendingPrDimmer").removeClass("active");
                    if (data.message != undefined) {
                        $("#message").show();
                        $("#responseMessage").html(data.message);
                        return false;
                    }
                    $("#presentacion_modal_dlg").modal('hide');

                    let hoy = moment();
                    let day = parseInt(hoy.format('D'));
                    let dias_aviso = parseInt(params["dias_aviso_presentacion"]);

                    if (day > dias_aviso) {
                        $('.contentImportante').html(params["dias_presentacion_aviso"]);
                        $('#importante_modal_dlg').modal('show');
                    }

                    getTotalMonth(focusDate._d);
                    return;
                }).catch((error) => {
                    console.log(error);
                });
        }

        function enviarInforme(informeData) {
            let idPresentacion = presentationData["id"];
            let raw = JSON.stringify(informeData);

            let requestOptions = {
                method: 'POST',
                headers: getMyHeader(),
                body: raw,
                redirect: 'follow'
            };

            let url = `${apiUrl}/presentaciones.php?id=${idPresentacion}?presentacion&informe`;

            $("#sendingInfDimmer").addClass("active");
            fetch(url, requestOptions)
                .then(function (res) {
                    return res.json(); //error here
                }).then(function (data) {
                    $("#sendingInfDimmer").removeClass("active");
                    $("#informe_modal_dlg").modal('hide');

                    let hoy = moment();
                    let day = parseInt(hoy.format('D'));
                    let dias_aviso = parseInt(params["dias_aviso_informe"]);

                    if (day > dias_aviso) {
                        $('.contentImportante').html(params["dias_informe_aviso"]);
                        $('#importante_modal_dlg').modal('show');
                    }

                    getTotalMonth(focusDate._d);
                    return;
                }).catch((error) => {
                    console.log(error);
                });
        }

        function cargarParametros() {
            let requestOptions = {
                method: 'GET',
                headers: getMyHeader(),
                redirect: 'follow'
            };

            let url = `${apiUrl}/params.php`;

            fetch(url, requestOptions)
                .then(function (res) {
                    return res.json(); //error here
                }).then(function (data) {
                    for (i in data) {
                        let element = data[i];
                        params[element.descripcion] = element.valor;
                    }
                    return;
                }).catch((error) => {
                    console.log(error);
                });
        }

        function saveFocusDate() {
            localStorage.setItem("focusDate", focusDate.format("YYYY-MM-DDTHH:mm:ss"));
        };

        function setCalFocusDate() {
            $('#inline_calendar').calendar('set focusDate', focusDate._d);
            $('#inline_calendar').calendar('set date', focusDate._d);
        }

        function enviarTarea(tipo) {
            let user = JSON.parse(localStorage.getItem('user'));

            desde = focusDate.format("YYYY-MM-DD HH:mm");
            hasta = focusDate.format("YYYY-MM-DD HH:mm");

            let raw = JSON.stringify({ "id_at": user.id, "id_pac": pac, "type": tipo, "desde": desde, "hasta": hasta, "intern": false });

            let requestOptions = {
                method: 'POST',
                headers: getMyHeader(),
                body: raw,
                redirect: 'follow'
            };

            let url = `${apiUrl}/visitas.php`;

            $("#message").hide();
            $("#savingDimmer").addClass("active");
            fetch(url, requestOptions)
                .then(function (res) {
                    return res.json(); //error here
                }).then(function (data) {
                    getTotalMonth(focusDate._d);
                    return true;
                }).catch((error) => {
                    return false;
                });
            return false;
        }

        function eliminarTarea() {
            if (tareaEspId == null) {
                return;
            }
            let user = JSON.parse(localStorage.getItem('user'));

            let requestOptions = {
                method: 'DELETE',
                headers: getMyHeader(),
                redirect: 'follow'
            };

            let url = `${apiUrl}/visitas.php?id=${tareaEspId}`;

            $("#message").hide();
            console.log(url);

            $("#savingDimmer").addClass("active");
            fetch(url, requestOptions)
                .then(function (res) {
                    getTotalMonth(focusDate._d);
                    return res.json();
                }).then(function (data) {
                    getTotalMonth(focusDate._d);
                    return true;
                }).catch((error) => {
                    console.log(error);
                    return false;
                });
            return true;
        }
    </script>

</body>

</html>
